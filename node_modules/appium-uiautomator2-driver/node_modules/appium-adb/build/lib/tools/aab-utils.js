"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger.js"));
var _path = _interopRequireDefault(require("path"));
var _support = require("@appium/support");
var _lruCache = _interopRequireDefault(require("lru-cache"));
var _helpers = require("../helpers.js");
var _asyncLock = _interopRequireDefault(require("async-lock"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _crypto = _interopRequireDefault(require("crypto"));
const AAB_CACHE = new _lruCache.default({
  max: 10,
  dispose: (hash, extractedFilesRoot) => _support.fs.rimraf(extractedFilesRoot)
});
const AAB_CACHE_GUARD = new _asyncLock.default();
const UNIVERSAL_APK = 'universal.apk';
const aabUtilsMethods = {};
process.on('exit', () => {
  if (!AAB_CACHE.size) {
    return;
  }
  const paths = [...AAB_CACHE.values()];
  _logger.default.debug(`Performing cleanup of ${paths.length} cached .aab ` + _support.util.pluralize('package', paths.length));
  for (const appPath of paths) {
    try {
      _support.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});
aabUtilsMethods.extractUniversalApk = async function extractUniversalApk(aabPath, opts = {}) {
  if (!(await _support.fs.exists(aabPath))) {
    throw new Error(`The file at '${aabPath}' either does not exist or is not accessible`);
  }
  const aabName = _path.default.basename(aabPath);
  const apkName = aabName.substring(0, aabName.length - _path.default.extname(aabName).length) + '.apk';
  const tmpRoot = await _support.tempDir.openDir();
  const tmpApksPath = _path.default.join(tmpRoot, `${aabName}.apks`);
  try {
    return await AAB_CACHE_GUARD.acquire(aabPath, async () => {
      const aabHash = await _support.fs.hash(aabPath);
      const {
        keystore,
        keystorePassword,
        keyAlias,
        keyPassword
      } = opts;
      let cacheHash = aabHash;
      if (keystore) {
        if (!(await _support.fs.exists(keystore))) {
          throw new Error(`The keystore file at '${keystore}' either does not exist ` + `or is not accessible`);
        }
        if (!keystorePassword || !keyAlias || !keyPassword) {
          throw new Error('It is mandatory to also provide keystore password, key alias, ' + 'and key password if the keystore path is set');
        }
        const keystoreHash = await _support.fs.hash(keystore);
        const keyAliasHash = _crypto.default.createHash('sha1');
        keyAliasHash.update(keyAlias);
        cacheHash = [cacheHash, keystoreHash, keyAliasHash.digest('hex')].join(':');
      }
      _logger.default.debug(`Calculated the cache key for '${aabPath}': ${cacheHash}`);
      if (AAB_CACHE.has(cacheHash)) {
        const resultPath = _path.default.resolve(AAB_CACHE.get(cacheHash), apkName);
        if (await _support.fs.exists(resultPath)) {
          return resultPath;
        }
        AAB_CACHE.del(cacheHash);
      }
      await this.initAapt2();
      const args = ['build-apks', '--aapt2', this.binaries.aapt2, '--bundle', aabPath, '--output', tmpApksPath, ...(keystore ? ['--ks', keystore, '--ks-pass', `pass:${keystorePassword}`, '--ks-key-alias', keyAlias, '--key-pass', `pass:${keyPassword}`] : []), '--mode=universal'];
      _logger.default.debug(`Preparing universal .apks bundle from '${aabPath}'`);
      await this.execBundletool(args, `Cannot build a universal .apks bundle from '${aabPath}'`);
      _logger.default.debug(`Unpacking universal application bundle at '${tmpApksPath}' to '${tmpRoot}'`);
      await (0, _helpers.unzipFile)(tmpApksPath, tmpRoot);
      let universalApkPath;
      const fileDeletionPromises = [];
      const allFileNames = await _support.fs.readdir(tmpRoot);
      for (const fileName of allFileNames) {
        const fullPath = _path.default.join(tmpRoot, fileName);
        if (fileName === UNIVERSAL_APK) {
          universalApkPath = fullPath;
        } else {
          fileDeletionPromises.push(_support.fs.rimraf(fullPath));
        }
      }
      try {
        await _bluebird.default.all(fileDeletionPromises);
      } catch (ign) {}
      if (!universalApkPath) {
        _logger.default.debug(`The following items were extracted from the .aab bundle: ${allFileNames}`);
        throw new Error(`${UNIVERSAL_APK} cannot be found in '${aabPath}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }
      const resultPath = _path.default.join(tmpRoot, apkName);
      _logger.default.debug(`Found ${UNIVERSAL_APK} at '${universalApkPath}'. Caching it to '${resultPath}'`);
      await _support.fs.mv(universalApkPath, resultPath);
      AAB_CACHE.set(cacheHash, tmpRoot);
      return resultPath;
    });
  } catch (e) {
    await _support.fs.rimraf(tmpRoot);
    throw e;
  }
};
var _default = aabUtilsMethods;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9nZ2VyIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfcGF0aCIsIl9zdXBwb3J0IiwiX2xydUNhY2hlIiwiX2hlbHBlcnMiLCJfYXN5bmNMb2NrIiwiX2JsdWViaXJkIiwiX2NyeXB0byIsIkFBQl9DQUNIRSIsIkxSVSIsIm1heCIsImRpc3Bvc2UiLCJoYXNoIiwiZXh0cmFjdGVkRmlsZXNSb290IiwiZnMiLCJyaW1yYWYiLCJBQUJfQ0FDSEVfR1VBUkQiLCJBc3luY0xvY2siLCJVTklWRVJTQUxfQVBLIiwiYWFiVXRpbHNNZXRob2RzIiwicHJvY2VzcyIsIm9uIiwic2l6ZSIsInBhdGhzIiwidmFsdWVzIiwibG9nIiwiZGVidWciLCJsZW5ndGgiLCJ1dGlsIiwicGx1cmFsaXplIiwiYXBwUGF0aCIsInJpbXJhZlN5bmMiLCJlIiwid2FybiIsIm1lc3NhZ2UiLCJleHRyYWN0VW5pdmVyc2FsQXBrIiwiYWFiUGF0aCIsIm9wdHMiLCJleGlzdHMiLCJFcnJvciIsImFhYk5hbWUiLCJwYXRoIiwiYmFzZW5hbWUiLCJhcGtOYW1lIiwic3Vic3RyaW5nIiwiZXh0bmFtZSIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInRtcEFwa3NQYXRoIiwiam9pbiIsImFjcXVpcmUiLCJhYWJIYXNoIiwia2V5c3RvcmUiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5QWxpYXMiLCJrZXlQYXNzd29yZCIsImNhY2hlSGFzaCIsImtleXN0b3JlSGFzaCIsImtleUFsaWFzSGFzaCIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJoYXMiLCJyZXN1bHRQYXRoIiwicmVzb2x2ZSIsImdldCIsImRlbCIsImluaXRBYXB0MiIsImFyZ3MiLCJiaW5hcmllcyIsImFhcHQyIiwiZXhlY0J1bmRsZXRvb2wiLCJ1bnppcEZpbGUiLCJ1bml2ZXJzYWxBcGtQYXRoIiwiZmlsZURlbGV0aW9uUHJvbWlzZXMiLCJhbGxGaWxlTmFtZXMiLCJyZWFkZGlyIiwiZmlsZU5hbWUiLCJmdWxsUGF0aCIsInB1c2giLCJCIiwiYWxsIiwiaWduIiwibXYiLCJzZXQiLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3Rvb2xzL2FhYi11dGlscy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IHVuemlwRmlsZSB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuY29uc3QgQUFCX0NBQ0hFID0gbmV3IExSVSh7XG4gIG1heDogMTAsXG4gIGRpc3Bvc2U6IChoYXNoLCBleHRyYWN0ZWRGaWxlc1Jvb3QpID0+IGZzLnJpbXJhZihleHRyYWN0ZWRGaWxlc1Jvb3QpLFxufSk7XG5jb25zdCBBQUJfQ0FDSEVfR1VBUkQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBVTklWRVJTQUxfQVBLID0gJ3VuaXZlcnNhbC5hcGsnO1xuXG5jb25zdCBhYWJVdGlsc01ldGhvZHMgPSB7fTtcblxucHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHtcbiAgaWYgKCFBQUJfQ0FDSEUuc2l6ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHBhdGhzID0gWy4uLkFBQl9DQUNIRS52YWx1ZXMoKV07XG4gIGxvZy5kZWJ1ZyhgUGVyZm9ybWluZyBjbGVhbnVwIG9mICR7cGF0aHMubGVuZ3RofSBjYWNoZWQgLmFhYiBgICtcbiAgICB1dGlsLnBsdXJhbGl6ZSgncGFja2FnZScsIHBhdGhzLmxlbmd0aCkpO1xuICBmb3IgKGNvbnN0IGFwcFBhdGggb2YgcGF0aHMpIHtcbiAgICB0cnkge1xuICAgICAgLy8gQXN5bmNocm9ub3VzIGNhbGxzIGFyZSBub3Qgc3VwcG9ydGVkIGluIG9uRXhpdCBoYW5kbGVyXG4gICAgICBmcy5yaW1yYWZTeW5jKGFwcFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgfVxuICB9XG59KTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBBcGtDcmVhdGlvbk9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlzdG9yZSBTcGVjaWZpZXMgdGhlIHBhdGggdG8gdGhlIGRlcGxveW1lbnQga2V5c3RvcmUgdXNlZFxuICogdG8gc2lnbiB0aGUgQVBLcy4gVGhpcyBmbGFnIGlzIG9wdGlvbmFsLiBJZiB5b3UgZG9uJ3QgaW5jbHVkZSBpdCxcbiAqIGJ1bmRsZXRvb2wgYXR0ZW1wdHMgdG8gc2lnbiB5b3VyIEFQS3Mgd2l0aCBhIGRlYnVnIHNpZ25pbmcga2V5LlxuICogSWYgdGhlIC5hcGsgaGFzIGJlZW4gYWxyZWFkeSBzaWduZWQgYW5kIGNhY2hlZCB0aGVuIGl0IGlzIG5vdCBnb2luZyB0byBiZSByZXNpZ25lZFxuICogdW5sZXNzIGEgZGlmZmVyZW50IGtleXN0b3JlIG9yIGtleSBhbGlhcyBpcyB1c2VkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleXN0b3JlUGFzc3dvcmQgU3BlY2lmaWVzIHlvdXIga2V5c3RvcmXigJlzIHBhc3N3b3JkLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5QWxpYXMgU3BlY2lmaWVzIHRoZSBhbGlhcyBvZiB0aGUgc2lnbmluZyBrZXkgeW91IHdhbnQgdG8gdXNlLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5UGFzc3dvcmQgU3BlY2lmaWVzIHRoZSBwYXNzd29yZCBmb3IgdGhlIHNpZ25pbmcga2V5LlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKi9cblxuLyoqXG4gKiBCdWlsZHMgYSB1bml2ZXJzYWwgLmFwayBmcm9tIHRoZSBnaXZlbiAuYWFiIHBhY2thZ2UuIFNlZVxuICogaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9idW5kbGV0b29sI2dlbmVyYXRlX2Fwa3NcbiAqIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFhYlBhdGggRnVsbCBwYXRoIHRvIHRoZSBzb3VyY2UgLmFhYiBwYWNrYWdlXG4gKiBAcGFyYW0ge0Fwa0NyZWF0aW9uT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMgVGhlIHBhdGggdG8gdGhlIHJlc3VsdGluZyB1bml2ZXJzYWwgLmFway4gVGhlIC5hcGsgaXMgc3RvcmVkIGluIHRoZSBpbnRlcm5hbCBjYWNoZVxuICogYnkgZGVmYXVsdC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgY3JlYXRpbmcgdGhlIHVuaXZlcnNhbCAuYXBrXG4gKi9cbmFhYlV0aWxzTWV0aG9kcy5leHRyYWN0VW5pdmVyc2FsQXBrID0gYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFVuaXZlcnNhbEFwayAoYWFiUGF0aCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGFhYlBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZmlsZSBhdCAnJHthYWJQYXRofScgZWl0aGVyIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICBjb25zdCBhYWJOYW1lID0gcGF0aC5iYXNlbmFtZShhYWJQYXRoKTtcbiAgY29uc3QgYXBrTmFtZSA9IGFhYk5hbWUuc3Vic3RyaW5nKDAsIGFhYk5hbWUubGVuZ3RoIC0gcGF0aC5leHRuYW1lKGFhYk5hbWUpLmxlbmd0aCkgKyAnLmFwayc7XG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgY29uc3QgdG1wQXBrc1BhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgYCR7YWFiTmFtZX0uYXBrc2ApO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBBQUJfQ0FDSEVfR1VBUkQuYWNxdWlyZShhYWJQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhYWJIYXNoID0gYXdhaXQgZnMuaGFzaChhYWJQYXRoKTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAga2V5c3RvcmUsXG4gICAgICAgIGtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgIGtleUFsaWFzLFxuICAgICAgICBrZXlQYXNzd29yZCxcbiAgICAgIH0gPSBvcHRzO1xuICAgICAgbGV0IGNhY2hlSGFzaCA9IGFhYkhhc2g7XG4gICAgICBpZiAoa2V5c3RvcmUpIHtcbiAgICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoa2V5c3RvcmUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUga2V5c3RvcmUgZmlsZSBhdCAnJHtrZXlzdG9yZX0nIGVpdGhlciBkb2VzIG5vdCBleGlzdCBgICtcbiAgICAgICAgICAgIGBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICAgICAgICB9XG4gICAgICAgIGlmICgha2V5c3RvcmVQYXNzd29yZCB8fCAha2V5QWxpYXMgfHwgIWtleVBhc3N3b3JkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJdCBpcyBtYW5kYXRvcnkgdG8gYWxzbyBwcm92aWRlIGtleXN0b3JlIHBhc3N3b3JkLCBrZXkgYWxpYXMsICcgK1xuICAgICAgICAgICAgJ2FuZCBrZXkgcGFzc3dvcmQgaWYgdGhlIGtleXN0b3JlIHBhdGggaXMgc2V0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qga2V5c3RvcmVIYXNoID0gYXdhaXQgZnMuaGFzaChrZXlzdG9yZSk7XG4gICAgICAgIGNvbnN0IGtleUFsaWFzSGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gICAgICAgIGtleUFsaWFzSGFzaC51cGRhdGUoa2V5QWxpYXMpO1xuICAgICAgICBjYWNoZUhhc2ggPSBbY2FjaGVIYXNoLCBrZXlzdG9yZUhhc2gsIGtleUFsaWFzSGFzaC5kaWdlc3QoJ2hleCcpXS5qb2luKCc6Jyk7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYENhbGN1bGF0ZWQgdGhlIGNhY2hlIGtleSBmb3IgJyR7YWFiUGF0aH0nOiAke2NhY2hlSGFzaH1gKTtcbiAgICAgIGlmIChBQUJfQ0FDSEUuaGFzKGNhY2hlSGFzaCkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucmVzb2x2ZShBQUJfQ0FDSEUuZ2V0KGNhY2hlSGFzaCksIGFwa05hbWUpO1xuICAgICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHJlc3VsdFBhdGgpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgQUFCX0NBQ0hFLmRlbChjYWNoZUhhc2gpO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmluaXRBYXB0MigpO1xuICAgICAgY29uc3QgYXJncyA9IFtcbiAgICAgICAgJ2J1aWxkLWFwa3MnLFxuICAgICAgICAnLS1hYXB0MicsIHRoaXMuYmluYXJpZXMuYWFwdDIsXG4gICAgICAgICctLWJ1bmRsZScsIGFhYlBhdGgsXG4gICAgICAgICctLW91dHB1dCcsIHRtcEFwa3NQYXRoLFxuICAgICAgICAuLi4oa2V5c3RvcmUgPyBbXG4gICAgICAgICAgJy0ta3MnLCBrZXlzdG9yZSxcbiAgICAgICAgICAnLS1rcy1wYXNzJywgYHBhc3M6JHtrZXlzdG9yZVBhc3N3b3JkfWAsXG4gICAgICAgICAgJy0ta3Mta2V5LWFsaWFzJywga2V5QWxpYXMsXG4gICAgICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke2tleVBhc3N3b3JkfWAsXG4gICAgICAgIF0gOiBbXSksXG4gICAgICAgICctLW1vZGU9dW5pdmVyc2FsJ1xuICAgICAgXTtcbiAgICAgIGxvZy5kZWJ1ZyhgUHJlcGFyaW5nIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcbiAgICAgIGF3YWl0IHRoaXMuZXhlY0J1bmRsZXRvb2woYXJncywgYENhbm5vdCBidWlsZCBhIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcblxuICAgICAgbG9nLmRlYnVnKGBVbnBhY2tpbmcgdW5pdmVyc2FsIGFwcGxpY2F0aW9uIGJ1bmRsZSBhdCAnJHt0bXBBcGtzUGF0aH0nIHRvICcke3RtcFJvb3R9J2ApO1xuICAgICAgYXdhaXQgdW56aXBGaWxlKHRtcEFwa3NQYXRoLCB0bXBSb290KTtcbiAgICAgIGxldCB1bml2ZXJzYWxBcGtQYXRoO1xuICAgICAgY29uc3QgZmlsZURlbGV0aW9uUHJvbWlzZXMgPSBbXTtcbiAgICAgIGNvbnN0IGFsbEZpbGVOYW1lcyA9IGF3YWl0IGZzLnJlYWRkaXIodG1wUm9vdCk7XG4gICAgICBmb3IgKGNvbnN0IGZpbGVOYW1lIG9mIGFsbEZpbGVOYW1lcykge1xuICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguam9pbih0bXBSb290LCBmaWxlTmFtZSk7XG4gICAgICAgIGlmIChmaWxlTmFtZSA9PT0gVU5JVkVSU0FMX0FQSykge1xuICAgICAgICAgIHVuaXZlcnNhbEFwa1BhdGggPSBmdWxsUGF0aDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWxlRGVsZXRpb25Qcm9taXNlcy5wdXNoKGZzLnJpbXJhZihmdWxsUGF0aCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBCLmFsbChmaWxlRGVsZXRpb25Qcm9taXNlcyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICBpZiAoIXVuaXZlcnNhbEFwa1BhdGgpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZm9sbG93aW5nIGl0ZW1zIHdlcmUgZXh0cmFjdGVkIGZyb20gdGhlIC5hYWIgYnVuZGxlOiAke2FsbEZpbGVOYW1lc31gKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1VOSVZFUlNBTF9BUEt9IGNhbm5vdCBiZSBmb3VuZCBpbiAnJHthYWJQYXRofScgYnVuZGxlLiBgICtcbiAgICAgICAgICBgRG9lcyB0aGUgYXJjaGl2ZSBjb250YWluIGEgdmFsaWQgYXBwbGljYXRpb24gYnVuZGxlP2ApO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGguam9pbih0bXBSb290LCBhcGtOYW1lKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgJHtVTklWRVJTQUxfQVBLfSBhdCAnJHt1bml2ZXJzYWxBcGtQYXRofScuIENhY2hpbmcgaXQgdG8gJyR7cmVzdWx0UGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy5tdih1bml2ZXJzYWxBcGtQYXRoLCByZXN1bHRQYXRoKTtcbiAgICAgIEFBQl9DQUNIRS5zZXQoY2FjaGVIYXNoLCB0bXBSb290KTtcbiAgICAgIHJldHVybiByZXN1bHRQYXRoO1xuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFhYlV0aWxzTWV0aG9kcztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQSxJQUFBQSxPQUFBLEdBQUFDLHNCQUFB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